<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:include="/health/header" />
<style>
    .tab-content>.tab-pane, .pill-content>.pill-pane {
	display: block;
	height: 0;
	overflow-y: hidden;
}

.tab-content>.active, .pill-content>.active {
	height: auto;
}
</style>

<body>
    <tt:constant enumcode="publicity-material-type,grant-target-type" />
    <input type="hidden" name="year" />
    <section class="content-header">
        <h1>宣传资料统计</h1>
    </section>
    <section class="content">
        <div class="nav-tabs-custom">
            <ul class="nav nav-tabs">
                <li class="active"><a href="#tab1" data-toggle="tab" aria-expanded="true">按年份统计</a></li>
                <li class=""><a href="#tab2" data-toggle="tab" aria-expanded="false">按机构统计</a></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" id="tab1">
                    <div class="box-body">
                        <ul class="products-list product-list-in-box">
                            <li class="item">
                                <form id="searchbar1" class="form-horizontal">
                                    <div class="form-group">
                                        <div class="col-md-2">
                                            <input type="text" id="workCycle" name="workCycle" class="form-control tonto-datepicker-year" autocomplete="off" placeholder="请选择工作周期">
                                        </div>
                                        <div class="col-md-10">
                                            <div class="pull-right">
                                                <button type="button" style="width:100px" class="btn btn-primary " onclick="yearQuery()"><i class="fa fa-search"></i>查询</button>
                                                <button type="button" style="width:100px" class="btn btn-default" onclick="$('#searchbar1')[0].reset()"><i class="fa fa-repeat"></i>重置</button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 表单仅有一个text-input时回车会提交表单，这里添加一个无用的防止回车提交 -->
                                    <input type="text" style="display:none">
                                </form>
                            </li>
                            <li class="item">
                                <div class="col-sm-12">
                                    <div id="yearCharts" style="height: 400px"></div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="tab-pane" id="tab2">
                    <div class="box-body">
                        <ul class="products-list product-list-in-box">
                            <li class="item">
                                <form id="searchbar2" class="form-horizontal form-search">
                                    <div class="form-group">
                                        <div class="col-md-2">
                                            <input type="text" id="agencyName2" name="agencyName" class="form-control" placeholder="请输入机构">
                                        </div>
                                        <div class="col-md-2">
                                            <input type="text" id="workCycle1" name="workCycle" class="form-control tonto-datepicker-year" autocomplete="off" placeholder="请选择工作周期">
                                        </div>
                                        <div class="col-md-8">
                                            <div class="pull-right">
                                                <button type="button" style="width:100px" class="btn btn-primary " onclick="agencyQuery()"><i class="fa fa-search"></i>查询</button>
                                                <button type="button" style="width:100px" class="btn btn-default" onclick="$('#searchbar2')[0].reset()"><i class="fa fa-repeat"></i>重置</button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 表单仅有一个text-input时回车会提交表单，这里添加一个无用的防止回车提交 -->
                                    <input type="text" style="display:none">
                                </form>
                            </li>
                            <li class="item">
                                <table id="dataGrid"></table>
                                <div id="toolbar">
                                    <div class="btn-group">
                                    </div>
                                </div>
                            </li>
                            <li class="item">
                                <span class="pull-right" id="daohang"></span>
                                <div class="col-sm-12">
                                    <div id="agencyCharts" style="height: 400px"></div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    
                </div>
            </div>
        </div>
    </section>
    <div th:include="/health/footer" />
    <script type="text/javascript">
    var table;
    $(function() {
        initDataGrid();
        chartsYear(yearCharts);
        chartsAgency(agencyCharts);

    });

    function initDataGrid() {     

        table = $.createTable("#dataGrid", {
            idField: "id",
            columns: [
                [
                    { title: "机构名称", align: "center", field: "name" },
                    { title: "发放量", align: "center", field: "total" },
                ]
            ],
            url: '/platform/grant/agency',
            searchbar: '#searchbar2',
            showColumns: true,
            pagination: true,
            toolbar: "#toolbar",
            showRefresh: true
        });
    }

    //图表自适应大小      
    window.addEventListener("resize", function() {
        agencyCharts.resize();
        yearCharts.resize();
    });
    var yearCharts = echarts.init(document.getElementById('yearCharts'));
    var agencyCharts = echarts.init(document.getElementById('agencyCharts'));

    function chartsAgency(agencyCharts) {
        var agencyNameVal = $("#agencyName2").val();
        var workCycleVal = $("#workCycle1").val();
        var agencyName = agencyNameVal.length > 0 ? agencyNameVal : null;
        var workCycle = workCycleVal.length > 0 ? workCycleVal : null;
        $.postAjax("/platform/grant/agency", { 'agencyName': agencyName, 'workCycle': workCycle }, function(result) {
            var list = result.data;
            if (list.length === 1 && list[0].total === 0) {
                showChartInfo(agencyCharts, '暂无数据');
                return false;
            }
            var chartValue = [];
            var chartName = [];
            list.forEach(function(item) {
                chartValue.push({
                    value: item.total,
                });
                chartName.push({
                    value: item.name,
                    id:item.id
                });
            })
            var labelOption = {
                normal: {
                    show: true,
                    position: 'top',
                    distance: 15,
                    align: 'center',
                    verticalAlign: 'top',
                    rotate: 0,
                    formatter: '{name|{a}}	 {c}',
                    fontSize: 12,
                    rich: {
                        name: {
                            textBorderColor: '#fff'
                        }
                    }
                }
            };
            option = {
                color: ['#3398DB'],
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { // 坐标轴指示器，坐标轴触发有效
                        type: 'shadow' // 默认为直线，可选为：'line' | 'shadow'
                    },
                    formatter: function(params) {
                        return params[0].name + '<br/> ' +
                            params[0].seriesName + ':' +
                            params[0].data.value + '(个数)<br/>'
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: [{
                    name:'机构',
                    type: 'category',
                    data: chartName,
                    axisTick: {
                        alignWithLabel: true
                    }
                }],
                yAxis: [{
                    name:'发放量',
                    type: 'value'
                }],
                series: [{
                    name: '发放量',
                    type: 'bar',
                    barWidth: '60%',
                    label: labelOption,
                    barGap: 0,
                    data: chartValue
                }]
            };
            agencyCharts.setOption(option, true);
        });
        //扩大点击范围
        agencyCharts.getZr().on('click',params=>{
            const pointInPixel= [params.offsetX, params.offsetY];
            if (agencyCharts.containPixel('grid',pointInPixel)) {
                let xIndex=agencyCharts.convertFromPixel({seriesIndex:0},[params.offsetX, params.offsetY])[0];
                /*事件处理代码书写位置*/

                //获取当前图表的option
                let option = agencyCharts.getOption();

                //获得图表中我们想要的数据
                let data=option.xAxis[0].data[xIndex];

                initChildChart(data.id,data.value);

            }
        });
    }
    function chartsYear(yearCharts) {
        var workCycle = $("#workCycle").val();
        $.postAjax("/platform/grant/year", { 'workCycle': workCycle }, function(result) {
            var list = result.data;
            if (list.length === 0) {
                showChartInfo(yearCharts, '暂无数据');
                return false;
            }
            var chartValue = [];
            var chartName = [];
            list.forEach(function(item) {
                chartValue.push({
                    value: item.total
                });
                chartName.push({
                    value: item.workCycle + '年'
                });
            })
            var labelOption = {
                normal: {
                    show: true,
                    position: 'top',
                    distance: 15,
                    align: 'center',
                    verticalAlign: 'top',
                    rotate: 0,
                    formatter: '{name|{a}}	 {c}',
                    fontSize: 12,
                    rich: {
                        name: {
                            textBorderColor: '#fff'
                        }
                    }
                }
            };
            option = {
                color: ['#3398DB'],
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { // 坐标轴指示器，坐标轴触发有效
                        type: 'shadow' // 默认为直线，可选为：'line' | 'shadow'
                    },
                    formatter: function(params) {
                        return params[0].name + '<br/> ' +
                            params[0].seriesName + ':' +
                            params[0].data.value + '(个数)<br/>'
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                toolbox: {
                    show: true,
                    right: 75,
                    feature: {
                        mark: { show: true },
                        dataView: { show: true, readOnly: false },
                        magicType: { show: true, type: ['line', 'bar'] },
                        restore: { show: true },
                        saveAsImage: { show: true }
                    }
                },
                calculable: true,
                xAxis: [{
                    type: 'category',
                    data: chartName,
                    axisTick: {
                        alignWithLabel: true
                    }
                }],
                yAxis: [{
                    type: 'value'
                }],
                series: [{
                    name: '发放量',
                    type: 'bar',
                    barWidth: '60%',
                    label: labelOption,
                    barGap: 0,
                    data: chartValue,
                }]
            };
            yearCharts.setOption(option, true);
        });
    }


    function agencyQuery() {
        chartsAgency(agencyCharts);
        table.refresh();
    }

    function yearQuery() {
        chartsYear(yearCharts);
    }

    function initChildChart(id,name) {
        $.get('/platform/grant/agency?id='+ id).done(function(res) {
            var myChart1 = echarts.init(document.getElementById('agencyCharts'));
            var list = res.result;
            if (list == null || list[0].total === 0) {
                showChartInfo(myChart1, name +'：下方机构暂无发放量');
                return false;
            }
            var chartValue = [];
            var chartName = [];
            list.forEach(function(item) {
                chartValue.push({
                    value: item.total,
                    id:item.id
                });
                chartName.push({
                    value: item.name
                });
            })
            var labelOption = {
                normal: {
                    show: true,
                    position: 'top',
                    distance: 15,
                    align: 'center',
                    verticalAlign: 'top',
                    rotate: 0,
                    formatter: '{name|{a}}	 {c}',
                    fontSize: 12,
                    rich: {
                        name: {
                            textBorderColor: '#fff'
                        }
                    }
                }
            };


            var month = {
                color: ['#3398DB'],
                title: {
                    show: true,
                    textStyle: {
                        color: 'grey',
                        fontSize: 20
                    },
                    text: name,
                    left: 'center',
                    top: 'top'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { // 坐标轴指示器，坐标轴触发有效
                        type: 'shadow' // 默认为直线，可选为：'line' | 'shadow'
                    },
                    formatter: function(params) {
                        return params[0].name + '<br/> ' +
                            params[0].seriesName + ':' +
                            params[0].data.value + '(个数)<br/>'
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: [{
                    name:'机构',
                    type: 'category',
                    data: chartName,
                    axisTick: {
                        alignWithLabel: true
                    }
                }],
                yAxis: [{
                    name:'发放量',
                    type: 'value'
                }],
                series: [{
                    name: '发放量',
                    type: 'bar',
                    barWidth: '60%',
                    label: labelOption,
                    barGap: 0,
                    data: chartValue
                }]
            };
            myChart1.clear(); //initChart(divId): get echarts instance, you can get it by using other method
            myChart1.hideLoading();
            myChart1.setOption(month);
        })
    }
    var  pId, pName;
    function initDaohang(data) {
        let $daohang = $("#daohang");
        let dHtml = $daohang.html();
        if (!dHtml || !data) {
            dHtml = '  <a   href="javascript:void (0)" onclick="chartsAgency(agencyCharts)" ><i class="fa fa-reply"></i>全部</a>';
        }
        if (data) {
            if (pId && pName) {
                dHtml += '  <a   href="javascript:void (0)" onclick="initChildChart(' + pId + ","+pName + ')">' +pName+ '</a>';
            }
            data.forEach(function (m) {
                pId = m.pId;
                pName = m.pName;
                dHtml += '<span >' + "&nbsp;> &nbsp;" + '</span>';
                dHtml += '<span id="' +pId+ '">' + m.pName + '</span>';
            });
        }
        $daohang.html(dHtml);
    }


    //无数据展示
    var showChartInfo = function(chart, infoStr) {
        var msgOption = {
            title: {
                show: true,
                textStyle: {
                    color: 'grey',
                    fontSize: 20
                },
                text: infoStr,
                left: 'center',
                top: 'center'
            },
            xAxis: {
                show: false
            },
            yAxis: {
                show: false
            },
            series: []
        };
        chart.clear(); //initChart(divId): get echarts instance, you can get it by using other method
        chart.hideLoading();
        chart.setOption(msgOption)
    };
    </script>
</body>

</html>