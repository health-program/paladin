<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<title>昆山健康宣教系统</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<style type="text/css">
td {
    vertical-align: middle;
    text-align: center;
    padding: 5px;
    border: 1px solid #ddd;
    line-height: 1.42857143;
}

table {
    width: 1070px;
    border-spacing: 0;
    border-collapse: collapse;
    margin-bottom: 0;
}

pre {
    white-space: pre-wrap;
    word-wrap: break-word;
}

body {
    padding: 2px;
    font: 400 13.3333px Arial;
    text-size-adjust: 100%;
    word-wrap: break-word;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
}

@page {
    size: auto;
    margin: 0mm;
}

.container1 {
    width: 1070px;
    margin: 0 auto;

    /*设置整个容器在浏览器中水平居中*/
}

.container2 {
    width: 1070px;
    margin: 0 auto;
    padding-right: 40px;
}

dl {
    display: block;
    margin-block-start: 1em;
    margin-block-end: 1em;
    margin-inline-start: 0px;
    margin-inline-end: 0px;
    margin-top: 0;
    margin-bottom: 20px;
}

dt {
    float: left;
    width: 120px;
    overflow: hidden;
    clear: left;
    text-align: right;
    text-overflow: ellipsis;
    white-space: nowrap;
    line-height: 1.42857143;
    font-weight: 700;
    display: block;
}

dd {
    margin-left: 130px;
    line-height: 1.42857143;
}
</style>

<body onload="load()">
    <input type="hidden" th:value="${searchId}" id="searchId" />
    <input type="hidden" th:value="${accessKey}" id="accessKey" />
    <div style="display: none" th:utext="${record}" id="prescription" />
    <div class="container1">
        <div>
            <!-- <a href="javascript:void(0);" style="margin-right: 20px" onclick="preview();">打印</a> -->
            <a href="javascript:void(0);" style="margin-right: 20px" id="updateBtn" onclick="update();">确认</a>
            <a href="javascript:void(0);" id="update2pdfBtn" onclick="update2pdf();">确认并获取PDF</a>
        </div>
        <div id="content"></div>
    </div>
</body>
<script type="text/javascript" src="/static/assets/jquery/jquery-2.2.4.min.js"></script>
<script type="text/javascript">
var record;
var editedPrescription;
var accessKey, searchId;

function load() {
    accessKey = $("#accessKey").val();
    searchId = $("#searchId").val();
    var dom = document.getElementById("prescription");
    record = JSON.parse(dom.textContent);
    record.targetCondition = JSON.parse(record.targetCondition);
    record.prescription = JSON.parse(record.prescription);
    record.message = record.message ? JSON.parse(record.message) : null;

    var target = record.targetCondition;
    if (target) {
        target.sex = target.sex === 1 ? '男' : (target.sex === 0 ? '女' : '')
        target.birthday = target.birthday ? dateFormat(target.birthday * 1) : ''
    } else {
        target = {};
    }

    record.createTime = record.createTime ? dateFormat(record.createTime * 1) : ''
    $("#content").html(createHtml());
}

function createHtml(isPrint) {
    var target = record.targetCondition;
    var html = '<table><tr>' +
        '    <td width="120px;">姓名</td>' +
        '    <td width="415px">' + (target.name || '') + '</td>' +
        '    <td width="120px;">性别</td>' +
        '    <td width="415px">' + (target.sex || '') + '</td>' +
        '</tr>' +
        '<tr>' +
        '    <td>出生年月</td>' +
        '    <td>' + (target.birthday || '') + '</td>' +
        '    <td>评估时间</td>' +
        '    <td>' + (record.createTime || '') + '</td>' +
        '</tr>';
    html += createMessageHtml(record.message);
    html += createEvaluateHtml(record.prescription, isPrint);
    html += "</table>";
    return html;
}

function createMessageHtml(message) {
    return '<tr>' +
        '    <td><input type="checkbox" checked onclick="checkMessage(this)"/>短信提醒</td>' +
        '    <td colspan="3" style="text-align:left">' +
        '    <textarea id="messageInput" rows="3" style="width:100%">' + message[0] + '</textarea>' +
        '    </td>' +
        '</tr>';

}


var messageChecked = true;

function checkMessage(checkbox) {
    messageChecked = checkbox.checked;
}

function check(checkbox, i) {
    var checked = checkbox.checked;
    $("#suggest" + i).attr("disabled", !checked);
    record.prescription[i].checked = checked;
}

function createEvaluateHtml(data, isPrint) {
    var html = "";
    if (data) {
        for (var i = 0; i < data.length; i++) {
            if (data[i].checked === false) continue;
            if (isPrint) {
                html += '<tr><td>' + data[i].name + '</br><b>(' + data[i].riskLevelName + ')</b>' + '</td><td colspan="3" style="text-align:left">' + createEvaluateItemHtml(data, i, isPrint) + '</td></tr>';
            } else {
                html += '<tr><td><input type="checkbox" checked onclick="check(this,' + i + ')">' + data[i].name + '</br><b>(' + data[i].riskLevelName + ')</b>' + '</td><td colspan="3" style="text-align:left">' + createEvaluateItemHtml(data, i, isPrint) + '</td></tr>';
            }
        }
    }
    return html;
}

function createEvaluateItemHtml(data, index, isPrint) {
    if (isPrint) {
        return parseEvaluateContentForPrint(editedPrescription[index]);
    } else {
        return "<textarea class='suggest' id='suggest" + index + "' rows='10' style='width:100%'>" + parseEvaluateContent(data[index]) + "</textarea>";
    }
}

function parseEvaluateContent(data) {
    var content = data.suggest;

    if (data.code == 'hypertension' || data.code == 'osteoporosis') {
        content = content.replace(/(2\. *运动：|3\. *吸烟：|4\. *饮酒：|5\. *心理：)/g, "@#$1");
    }

    var arr = content.split('@#');
    var ps = [];

    for (var i = 0; i < arr.length; i++) {
        var a = arr[i];
        a = $.trim(a);
        if (a && a.length > 0 && a !== '3.吸烟：') {
            ps.push(a);
        }
    }

    var s = "";
    for (var i = 0; i < ps.length; i++) {
        s += "\t" + ps[i] + "\n";
    }
    return s;
}

function parseEvaluateContentForPrint(content) {
    return "<pre>" + content + "</pre>";
}

function getEditedPrescription() {
    var ts = $(".suggest");
    editedPrescription = [];
    for (var i = 0; i < ts.length; i++) {
        editedPrescription[i] = $(ts[i]).val();
    }
}

function preview() {
    getEditedPrescription();
    var bdhtml = window.document.body.innerHTML; //获取当前页的html代码
    var prnhtml = '<!--startprint--><div>' + createPrintHtml() + "</div><!--endprint-->";

    window.document.body.innerHTML = prnhtml;

    // if($(document).height() >1600) {
    //     var h = 70;
    //     var dls = $("dl");
    //     for(var i=0;i<dls.length;i++) {
    //         h += $(dls[i]).height();
    //         if(h>1700) {
    //             $('<div style="page-break-after: always;"></div>').insertBefore($(dls[i]));
    //             break;
    //         }
    //     }
    // }


    window.print();
    window.document.body.innerHTML = bdhtml;
}

function createPrintHtml() {

    var target = record.targetCondition;
    var html = '<div class="container2"><h3 style="text-align: center;">健康风险评估</h3>';
    html += '<div style="height: 40px;text-align: center;">' +
        '    <span style="width:100px;display: inline-block;">姓名：' + (target.name || '') + '</span>' +
        '    <span style="width:80px;display: inline-block;">性别：' + (target.sex || '') + '</span>' +
        '    <span style="width:150px;display: inline-block;">出生年月：' + (target.birthday || '') + '</span>' +
        '    <span style="width:150px;display: inline-block;">评估时间：' + (target.createTime || '') + '</span>' +
        '</div>';

    html += createPrintEvaluateHtml(record.prescription);
    html += '</div>';

    return html;
}

function createPrintEvaluateHtml(data) {
    var html = "";
    if (data) {
        for (var i = 0; i < data.length; i++) {
            var item = data[i];
            if (item.checked === false) continue;

            html += '<dl>' +
                ' <dt>评估内容：</dt>' +
                ' <dd>' + item.name + '</dd>' +
                ' <dt>风险等级：</dt>' +
                ' <dd>' + item.riskLevelName + '</dd>' +
                ' <dt>分析建议：</dt>' +
                ' <dd><pre>' + editedPrescription[i] + '</pre>' +
                ' </dd>' +
                '</dl>';
        }
    }
    return html;
}


var updating = false;

function getRequest(){
    getEditedPrescription();
    var request = [];
    var prescription = record.prescription;
    if (prescription) {
        for (var i = 0; i < prescription.length; i++) {
            var p = prescription[i];
            if (p.checked !== false) {
                request.push({
                    code: p.code,
                    riskLevel: p.riskLevel,
                    suggest: editedPrescription[i]
                });
            }
        }
    }

    if(!prescription) return null;

    var message = messageChecked ? $("#messageInput").val() : null;
    request = {
        sendMessage: message,
        evaluationItems: request
    }

    return request;
}

function update2pdf(){

    if (updating === true) {
        return;
    }

    request = getRequest();
    
    if (request) {
        updating = true;
        $.ajax({
            type: "POST",
            url: "/evaluate/simple/confirm2pdf?searchId=" + searchId + "&accessKey=" + accessKey,
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(request),
            dataType: "json",
            success: function(response) {
                if (response && response.status == 1) {
                	
                	var tempwindow=window.open('_blank'); // 先打开页面
                	tempwindow.location.href="/file" + response.message; // 后更改页面地址
                	
                    return;
                }
                alert(response.message);
            },
            error: function(result) {
                alert(result);
            },
            complete: function() {
                updating = false;
            }
        });
    }
}

function update() {
    if (updating === true) {
        return;
    }

    request = getRequest();
    
    if (request) {
        updating = true;
        $.ajax({
            type: "POST",
            url: "/evaluate/simple/confirm?searchId=" + searchId + "&accessKey=" + accessKey,
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(request),
            dataType: "json",
            success: function(response) {
                if (response && response.status == 1) {
                    var r = confirm("确认成功!是否关闭窗口");
                    if (r == true) {
                        window.close();
                    }

                    return;
                }
                alert(response.message);
            },
            error: function(result) {
                alert(result);
            },
            complete: function() {
                updating = false;
            }
        });
    }
}

/*  
 * 时间格式化工具 
 * 把Long类型的1527672756454日期还原yyyy-MM-dd格式日期   
 */
function dateFormat(longTypeDate) {
    var dateTypeDate = "";
    var date = new Date();
    date.setTime(longTypeDate);
    dateTypeDate += date.getFullYear(); //年    
    dateTypeDate += "-" + getMonth(date); //月     
    dateTypeDate += "-" + getDay(date); //日    
    return dateTypeDate;
}
//返回 01-12 的月份值     
function getMonth(date) {
    var month = "";
    month = date.getMonth() + 1; //getMonth()得到的月份是0-11    
    if (month < 10) {
        month = "0" + month;
    }
    return month;
}
//返回01-30的日期    
function getDay(date) {
    var day = "";
    day = date.getDate();
    if (day < 10) {
        day = "0" + day;
    }
    return day;
}
</script>

</html>