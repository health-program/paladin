<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<title>昆山健康宣教系统</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<style type="text/css">
td {
    vertical-align: middle;
    text-align: center;
    padding: 5px;
    border: 1px solid #ddd;
    line-height: 1.42857143;
}

table {
    width: 1070px;
    border-spacing: 0;
    border-collapse: collapse;
    margin-bottom: 0;
}

pre {
    white-space: pre-wrap;
    word-wrap: break-word;
}

body {
    padding: 2px;
    font: 400 13.3333px Arial;
    text-size-adjust: 100%;
    word-wrap: break-word;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
}

@page {
    size: auto;
    margin: 0mm;
}
</style>

</html>

<body onload="load()">
    <input type="hidden" th:value="${searchId}" id="searchId" />
    <input type="hidden" th:value="${accessKey}" id="accessKey" />
    <div style="display: none" th:utext="${record}" id="prescription" />
    <div><a href="javascript:void(0);" style="margin-right: 20px" onclick="preview();">打印</a><a href="javascript:void(0);" id="updateBtn" onclick="update();">确认</a></div>
    <div id="content"></div>
</body>
<script type="text/javascript" src="/static/assets/jquery/jquery-2.2.4.min.js"></script>
<script type="text/javascript">
var record;
var editedPrescription;
var accessKey, searchId;

function load() {
    accessKey = $("#accessKey").val();
    searchId = $("#searchId").val();
    var dom = document.getElementById("prescription");
    record = JSON.parse(dom.textContent);
    record.targetCondition = JSON.parse(record.targetCondition);
    record.prescription = JSON.parse(record.prescription);

    var target = record.targetCondition;
    if (target) {
        target.sex = target.sex === 1 ? '男' : (target.sex === 0 ? '女' : '')
        target.birthday = target.birthday ? dateFormat(target.birthday * 1) : ''
    } else {
        target = {};
    }

    record.createTime = record.createTime ? dateFormat(record.createTime * 1) : ''
    $("#content").html(createHtml());
}

function createHtml(isPrint) {
    var target = record.targetCondition;
    var html = '<table><tr>' +
        '    <td width="120px;">姓名</td>' +
        '    <td width="415px">' + (target.name || '') + '</td>' +
        '    <td width="120px;">性别</td>' +
        '    <td width="415px">' + (target.sex || '') + '</td>' +
        '</tr>' +
        '<tr>' +
        '    <td>出生年月</td>' +
        '    <td>' + (target.birthday || '') + '</td>' +
        '    <td>评估时间</td>' +
        '    <td>' + (record.createTime || '') + '</td>' +
        '</tr>';

    html += createEvaluateHtml(record.prescription, isPrint);
    html += "</table>";
    return html;
}

function check(checkbox, i) {
    var checked = checkbox.checked;
    $("#suggest" + i).attr("disabled", !checked);
    record.prescription[i].checked = checked;
}

function createEvaluateHtml(data, isPrint) {
    var html = "";
    if (data) {
        for (var i = 0; i < data.length; i++) {
            if (data[i].checked === false) continue;
            if (isPrint) {
                html += '<tr><td>' + data[i].name + '</br><b>(' + data[i].riskLevelName + ')</b>' + '</td><td colspan="3" style="text-align:left">' + createEvaluateItemHtml(data, i, isPrint) + '</td></tr>';
            } else {
                html += '<tr><td><input type="checkbox" checked onclick="check(this,' + i + ')">' + data[i].name + '</br><b>(' + data[i].riskLevelName + ')</b>' + '</td><td colspan="3" style="text-align:left">' + createEvaluateItemHtml(data, i, isPrint) + '</td></tr>';
            }
        }
    }
    return html;
}

function createEvaluateItemHtml(data, index, isPrint) {
    if (isPrint) {
        return parseEvaluateContentForPrint(editedPrescription[index]);
    } else {
        return "<textarea class='suggest' id='suggest" + index + "' rows='10' style='width:100%'>" + parseEvaluateContent(data[index]) + "</textarea>";
    }
}

function parseEvaluateContent(data) {
    var content = data.suggest;

    if (data.code == 'hypertension' || data.code == 'osteoporosis') {
        content = content.replace(/(2\. *运动：|3\. *吸烟：|4\. *饮酒：|5\. *心理：)/g, "@#$1");
    }

    var arr = content.split('@#');
    var ps = [];

    for (var i = 0; i < arr.length; i++) {
        var a = arr[i];
        a = $.trim(a);
        if (a && a.length > 0 && a !== '3.吸烟：') {
            ps.push(a);
        }
    }

    var s = "";
    for (var i = 0; i < ps.length; i++) {
        s += "\t" + ps[i] + "\n";
    }
    return s;
}

function parseEvaluateContentForPrint(content) {
    return "<pre>" + content + "</pre>";
}

function getEditedPrescription() {
    var ts = $(".suggest");
    editedPrescription = [];
    for (var i = 0; i < ts.length; i++) {
        editedPrescription[i] = $(ts[i]).val();
    }
}

function preview() {
    getEditedPrescription();
    var bdhtml = window.document.body.innerHTML; //获取当前页的html代码
    var prnhtml = '<!--startprint--><div>' + createHtml(true) + "</div><!--endprint-->";

    window.document.body.innerHTML = prnhtml;
    window.print();
    window.document.body.innerHTML = bdhtml;
}

var updating = false;

function update() {
    if (updating === true) {
        return;
    }

    getEditedPrescription();
    var request = [];
    var prescription = record.prescription;
    if (prescription) {
        for (var i = 0; i < prescription.length; i++) {
            var p = prescription[i];
            if (p.checked !== false) {
                request.push({
                    code: p.code,
                    riskLevel: p.riskLevel,
                    suggest: editedPrescription[i]
                });
            }
        }
    }

    if (prescription) {
        updating = true;
        $.ajax({
            type: "POST",
            url: "/evaluate/simple/confirm?searchId=" + searchId + "&accessKey=" + accessKey,
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(request),
            dataType: "json",
            success: function(response) {
                if (response && response.status == 1) {
                    var r = confirm("确认成功!是否关闭窗口");
                    if (r == true) {
                        window.close();
                    }

                    return;
                }
                alert(response.message);
            },
            error: function(result) {
                alert(result);
            },
            complete: function() {
                updating = false;
            }
        });
    }
}

/*  
 * 时间格式化工具 
 * 把Long类型的1527672756454日期还原yyyy-MM-dd格式日期   
 */
function dateFormat(longTypeDate) {
    var dateTypeDate = "";
    var date = new Date();
    date.setTime(longTypeDate);
    dateTypeDate += date.getFullYear(); //年    
    dateTypeDate += "-" + getMonth(date); //月     
    dateTypeDate += "-" + getDay(date); //日    
    return dateTypeDate;
}
//返回 01-12 的月份值     
function getMonth(date) {
    var month = "";
    month = date.getMonth() + 1; //getMonth()得到的月份是0-11    
    if (month < 10) {
        month = "0" + month;
    }
    return month;
}
//返回01-30的日期    
function getDay(date) {
    var day = "";
    day = date.getDate();
    if (day < 10) {
        day = "0" + day;
    }
    return day;
}
</script>

</html>